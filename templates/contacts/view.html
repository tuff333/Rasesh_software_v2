{% extends 'base.html' %}
{% block content %}

<div class="card shadow" style="max-width: 1000px; margin: auto;">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5>
      <i class="bi bi-person-badge"></i>
      Contact Details
    </h5>
    <div class="d-flex gap-2">
      <a href="{{ url_for('contacts.contacts_list') }}" class="btn btn-sm btn-secondary">
        <i class="bi bi-arrow-left"></i> Back
      </a>
      <a href="{{ url_for('contacts.analytics') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-graph-up"></i> Analytics
      </a>
      <a href="{{ url_for('contacts.companies') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-building"></i> Companies
      </a>
    </div>
  </div>

  <div class="card-body">

    <!-- Header Section -->
    <div class="d-flex align-items-center mb-4">

      <!-- Face Image / Avatar -->
      {% if contact['face_image_contact'] %}
      <img src="/{{ contact['face_image_contact'] }}"
           class="rounded-circle me-3"
           style="width: 100px; height: 100px; object-fit: cover;">
      {% else %}
      <div class="rounded-circle text-white d-flex justify-content-center align-items-center me-3"
           style="
             width: 100px;
             height: 100px;
             font-size: 36px;
             background: {{ avatar_color(contact['first_name_contact'] ~ ' ' ~ contact['last_name_contact']) }};
           ">
        {{ contact['first_name_contact'][:1] }}{{ contact['last_name_contact'][:1] }}
      </div>
      {% endif %}

      <div>
        <h3 class="mb-0">
          {{ contact['first_name_contact'] }} {{ contact['last_name_contact'] }}
        </h3>
        <div class="text-muted">{{ contact['position_contact'] or 'No Title' }}</div>
        <div class="fw-bold">{{ contact['company_contact'] or '' }}</div>

        <!-- STATUS BADGE -->
        <div class="mt-2">
          {% set s = contact['status'] or 'active' %}
          {% if s == 'active' %}
            <span class="badge bg-success">Active</span>
          {% elif s == 'lead' %}
            <span class="badge bg-info text-dark">Lead</span>
          {% elif s == 'customer' %}
            <span class="badge bg-primary">Customer</span>
          {% elif s == 'inactive' %}
            <span class="badge bg-secondary">Inactive</span>
          {% else %}
            <span class="badge bg-dark">{{ s }}</span>
          {% endif %}
        </div>

        <!-- STATUS UPDATE -->
        <form method="POST"
              action="{{ url_for('contacts.update_status', id=contact['id']) }}"
              class="mt-2">
          <div class="input-group input-group-sm" style="max-width: 260px;">
            <label class="input-group-text">Status</label>
            <select name="status" class="form-select">
              {% for opt in ['active','lead','customer','inactive','archived'] %}
                <option value="{{ opt }}" {% if (contact['status'] or 'active') == opt %}selected{% endif %}>
                  {{ opt }}
                </option>
              {% endfor %}
            </select>
            <button class="btn btn-outline-secondary">Update</button>
          </div>
        </form>

        <!-- PIPELINE UPDATE -->
        <form method="POST"
              action="{{ url_for('contacts.update_pipeline', id=contact['id']) }}"
              class="mt-2">
          <div class="input-group input-group-sm" style="max-width: 260px;">
            <label class="input-group-text">Stage</label>
            <select name="stage" class="form-select">
              {% set current_stage = contact['pipeline_stage'] or 'new' %}
              {% for st in ['new','contacted','qualified','proposal','won','lost'] %}
                <option value="{{ st }}" {% if current_stage == st %}selected{% endif %}>
                  {{ st }}
                </option>
              {% endfor %}
            </select>
            <button class="btn btn-outline-secondary">Move</button>
          </div>
        </form>

        <!-- TAGS -->
        {% if tags %}
          <div class="mt-2">
            {% for t in tags %}
              <span class="badge bg-secondary">{{ t }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Company Logo -->
      {% if contact['company_logo_contact'] %}
      <img src="/{{ contact['company_logo_contact'] }}"
           class="ms-auto"
           style="width: 90px; height: 90px; object-fit: contain;">
      {% endif %}
    </div>

    <hr>

    <!-- Contact Info -->
    <div class="row mb-4">
      <div class="col-md-6">
        <h6 class="text-primary"><i class="bi bi-envelope"></i> Email</h6>
        <p>
          {{ contact['email_contact'] or '-' }}
          {% if contact['email_contact'] %}
            <a href="{{ url_for('contacts.use_email_template', template_id=1, contact_id=contact['id']) }}"
               class="btn btn-sm btn-outline-primary ms-2">
              <i class="bi bi-envelope-open"></i> Use Template
            </a>
          {% endif %}
        </p>

        <h6 class="text-primary"><i class="bi bi-telephone"></i> Phone</h6>
        <p>{{ contact['phone_contact'] or '-' }}</p>

        <h6 class="text-primary"><i class="bi bi-globe"></i> Website</h6>
        <p>{{ contact['website_contact'] or '-' }}</p>
      </div>

      <div class="col-md-6">
        <h6 class="text-primary"><i class="bi bi-geo-alt"></i> Address</h6>
        <p>{{ contact['address_contact'] or '-' }}</p>

        <h6 class="text-primary"><i class="bi bi-card-text"></i> Notes</h6>
        <p>{{ contact['notes_contact'] or '-' }}</p>
      </div>
    </div>

    <hr>

    <!-- Business Card Section -->
    <h5 class="mb-3"><i class="bi bi-credit-card"></i> Business Card</h5>

    <div class="row">

      <div class="col-md-6 mb-3">
        <h6>Front</h6>
        {% if contact['business_card_front_contact'] %}
          {% if contact['business_card_front_contact'].endswith('.pdf') %}
            <a href="/{{ contact['business_card_front_contact'] }}" target="_blank" class="btn btn-outline-primary">
              <i class="bi bi-file-earmark-pdf"></i> View PDF
            </a>
          {% else %}
            <img src="/{{ contact['business_card_front_contact'] }}"
                 class="img-fluid rounded border">
          {% endif %}
        {% else %}
          <p class="text-muted">No front image uploaded.</p>
        {% endif %}
      </div>

      <div class="col-md-6 mb-3">
        <h6>Back</h6>
        {% if contact['business_card_back_contact'] %}
          {% if contact['business_card_back_contact'].endswith('.pdf') %}
            <a href="/{{ contact['business_card_back_contact'] }}" target="_blank" class="btn btn-outline-primary">
              <i class="bi bi-file-earmark-pdf"></i> View PDF
            </a>
          {% else %}
            <img src="/{{ contact['business_card_back_contact'] }}"
                 class="img-fluid rounded border">
          {% endif %}
        {% else %}
          <p class="text-muted">No back image uploaded.</p>
        {% endif %}
      </div>

    </div>

    <hr>

    <!-- Files + Reminders + Timeline Layout -->
    <div class="row">
      <!-- Files -->
      <div class="col-md-4 mb-4">
        <h5 class="mb-3"><i class="bi bi-folder"></i> Files</h5>

        <!-- Upload -->
        <form method="POST"
              action="{{ url_for('contacts.upload_file', id=contact['id']) }}"
              enctype="multipart/form-data"
              class="mb-3">
          <div class="input-group">
            <input type="file" name="file" class="form-control" required>
            <button class="btn btn-outline-primary">
              <i class="bi bi-upload"></i>
            </button>
          </div>
        </form>

        {% if files %}
          <ul class="list-group">
            {% for f in files %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold" style="word-break: break-all;">{{ f['filename'] }}</div>
                <small class="text-muted">{{ f['uploaded_at'] }}</small>
              </div>
              <div class="ms-2 d-flex align-items-center">
                <a href="{{ url_for('contacts.download_file', file_id=f['id']) }}"
                   class="btn btn-sm btn-outline-secondary me-1"
                   title="Download">
                  <i class="bi bi-download"></i>
                </a>
                <form method="POST"
                      action="{{ url_for('contacts.delete_file', file_id=f['id']) }}"
                      onsubmit="return confirm('Delete this file?');">
                  <button class="btn btn-sm btn-outline-danger" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No files uploaded yet.</p>
        {% endif %}
      </div>

      <!-- Reminders -->
      <div class="col-md-4 mb-4">
        <h5 class="mb-3"><i class="bi bi-bell"></i> Reminders</h5>

        <!-- Add Reminder -->
        <form method="POST"
              action="{{ url_for('contacts.add_reminder', id=contact['id']) }}"
              class="mb-3">
          <div class="mb-2">
            <input type="text"
                   name="reminder_title"
                   class="form-control"
                   placeholder="Follow up call, send quote..."
                   required>
          </div>
          <div class="input-group">
            <input type="date"
                   name="reminder_due_date"
                   class="form-control"
                   required>
            <button class="btn btn-outline-primary">
              <i class="bi bi-plus"></i>
            </button>
          </div>
        </form>

        {% if reminders %}
          <ul class="list-group">
            {% for r in reminders %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">{{ r['title'] }}</div>
                <small class="text-muted">
                  Due: {{ r['due_date'] }}
                  {% if r['status'] == 'done' %}
                    • <span class="text-success">Done</span>
                  {% else %}
                    • <span class="text-warning">Open</span>
                  {% endif %}
                </small>
              </div>
              <div class="ms-2 d-flex align-items-center">
                {% if r['status'] != 'done' %}
                <form method="POST"
                      action="{{ url_for('contacts.complete_reminder', reminder_id=r['id']) }}"
                      class="me-1">
                  <button class="btn btn-sm btn-outline-success" title="Mark as done">
                    <i class="bi bi-check2"></i>
                  </button>
                </form>
                {% endif %}
                <form method="POST"
                      action="{{ url_for('contacts.delete_reminder', reminder_id=r['id']) }}"
                      onsubmit="return confirm('Delete this reminder?');">
                  <button class="btn btn-sm btn-outline-danger" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No reminders yet.</p>
        {% endif %}
      </div>

      <!-- Timeline (Notes + Activity) -->
      <div class="col-md-4 mb-4">
        <h5 class="mb-3"><i class="bi bi-clock-history"></i> Timeline</h5>

        {% if notes or activity %}
          <div class="timeline-list" style="max-height: 360px; overflow-y: auto;">
            <!-- Notes -->
            {% for n in notes %}
            <div class="mb-2">
              <div class="small text-muted">
                <i class="bi bi-chat-left-text"></i>
                {{ n['timestamp'] }}
              </div>
              <div>{{ n['note_text'] }}</div>
              <form method="POST"
                    action="{{ url_for('contacts.delete_note', note_id=n['id']) }}"
                    class="mt-1">
                <button class="btn btn-sm btn-outline-danger btn-sm">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
              <hr class="my-2">
            </div>
            {% endfor %}

            <!-- Activity -->
            {% for a in activity %}
            <div class="mb-2">
              <div class="small text-muted">
                <i class="bi bi-activity"></i>
                {{ a['timestamp'] }} • {{ a['type'] }}
              </div>
              <div class="small">{{ a['description'] }}</div>
              <hr class="my-2">
            </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">No timeline entries yet.</p>
        {% endif %}

        <!-- Add Note -->
        <form method="POST"
              action="{{ url_for('contacts.add_note', id=contact['id']) }}"
              class="mt-3">
          <div class="input-group">
            <input type="text" name="note_text" class="form-control" placeholder="Add a note...">
            <button class="btn btn-primary">
              <i class="bi bi-plus"></i>
            </button>
          </div>
        </form>
      </div>
    </div>

    <hr>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-end mt-3 flex-wrap gap-2">

      <a href="mailto:{{ contact['email_contact'] }}"
         class="btn btn-outline-primary">
        <i class="bi bi-envelope"></i> Email
      </a>

      <a href="tel:{{ contact['phone_contact'] }}"
         class="btn btn-outline-success">
        <i class="bi bi-telephone"></i> Call
      </a>

      <a href="{{ url_for('contacts.export_ics', id=contact['id']) }}"
         class="btn btn-outline-warning">
        <i class="bi bi-calendar-event"></i> Meeting
      </a>

      <a href="{{ url_for('contacts.export_vcard', id=contact['id']) }}"
         class="btn btn-outline-secondary">
        <i class="bi bi-person-vcard"></i> vCard
      </a>

      <a href="{{ url_for('contacts.contacts_edit', id=contact['id']) }}"
         class="btn btn-outline-dark">
        <i class="bi bi-pencil"></i> Edit
      </a>

      <a href="{{ url_for('contacts.export_contact', id=contact['id']) }}"
         class="btn btn-outline-primary">
        <i class="bi bi-file-earmark-excel"></i> Export
      </a>

    </div>

  </div>
</div>

{% endblock %}
