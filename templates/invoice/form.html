{% extends 'base.html' %}
{% block content %}

<div class="card shadow">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-receipt"></i> Create Invoice</h5>
  </div>

  <div class="card-body">

    <form method="POST">

      <!-- Invoice Meta -->
      <div class="row mb-3">

        <!-- Invoice Type -->
        <div class="col-md-3">
          <label class="form-label">Invoice Type</label>
          <select name="invoice_type" class="form-select" required>
            <option value="Invoice">Invoice</option>
            <option value="Estimate">Estimate</option>
            <option value="Quote">Quote</option>
          </select>
        </div>

        <!-- Invoice Number -->
        <div class="col-md-3">
          <label class="form-label">Invoice Number</label>
          <input
            type="text"
            name="invoice_number"
            class="form-control"
            value="{{ suggested_invoice_number or '' }}"
            placeholder="MWR - 106">
        </div>

        <!-- Invoice Date -->
        <div class="col-md-3">
          <label class="form-label">Invoice Date</label>
          <input
            type="date"
            name="invoice_date"
            class="form-control"
            value="{{ today }}"
            required>
        </div>

        <!-- Vendor -->
        <div class="col-md-3">
          <label class="form-label d-flex justify-content-between">
            <span>Vendor</span>
            <a href="{{ url_for('vendor.vendor_add') }}" class="btn btn-sm btn-outline-primary">+ Add</a>
          </label>

          <select name="vendor_id" class="form-select" required>
            <option value="">Select Vendor</option>
            {% for v in vendors %}
            <option value="{{ v.id }}">{{ v.name }}</option>
            {% endfor %}
          </select>
        </div>

      </div>

      <!-- GST + Shipping Info -->
      <div class="row mb-3">

        <!-- GST -->
        <div class="col-md-3">
          <label class="form-label d-flex justify-content-between">
            <span>GST Number</span>
            <a href="{{ url_for('gst.gst_add') }}" class="btn btn-sm btn-outline-primary">+ Add</a>
          </label>

          <select name="gst_number" class="form-select">
            <option value="">None</option>
            {% for g in gst_numbers %}
            <option value="{{ g.gst_number }}"
              {% if default_gst and g.gst_number == default_gst %}selected{% endif %}>
              {{ g.gst_number }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- Shipping Method -->
        <div class="col-md-3">
          <label class="form-label">Shipping Method</label>
          <input type="text" name="ship_method" class="form-control">
        </div>

        <!-- Shipping Terms -->
        <div class="col-md-3">
          <label class="form-label">Shipping Terms</label>
          <input type="text" name="ship_terms" class="form-control">
        </div>

        <!-- Delivery Date -->
        <div class="col-md-3">
          <label class="form-label">Delivery Date</label>
          <input
            type="text"
            id="delivery_date"
            name="delivery_date"
            class="form-control"
            value="TBD"
            autocomplete="off">
        </div>
      </div>

      <!-- Comments + Terms -->
      <div class="mb-3">
        <label class="form-label">Comments</label>
        <textarea name="comments" class="form-control" rows="2"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Terms & Conditions</label>
        <textarea name="terms_conditions" class="form-control" rows="2"></textarea>
      </div>

      <!-- Signature / Template -->
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label d-flex justify-content-between">
            <span>Signature</span>
            <a href="{{ url_for('signature.signature_add') }}" class="btn btn-sm btn-outline-primary">+ Upload</a>
          </label>
          <select name="sig_id" class="form-select">
            <option value="">None</option>
            {% if signatures %}
              {% for s in signatures %}
              <option value="{{ s['id'] }}"
                {% if default_signature_id and s['id'] == default_signature_id %}selected{% endif %}>
                {{ s['name'] }}{% if s['position'] %} – {{ s['position'] }}{% endif %}
              </option>
              {% endfor %}
            {% endif %}
          </select>
        </div>

        <!-- Template + Preview Switcher -->
        <div class="col-md-4">
          <label class="form-label d-flex justify-content-between align-items-center">
            <span>Template</span>
            <div class="btn-group btn-group-sm" role="group" aria-label="Template preview switcher">
              <button type="button" class="btn btn-outline-secondary" id="tplClassicBtn">Classic</button>
              <button type="button" class="btn btn-outline-secondary" id="tplModernBtn">Modern</button>
            </div>
          </label>

          <select name="template" id="templateSelect" class="form-select">
            {% set tpl = default_template or 'classic' %}
            <option value="classic" {% if tpl == 'classic' %}selected{% endif %}>Classic</option>
            <option value="modern" {% if tpl == 'modern' %}selected{% endif %}>Modern</option>
          </select>
        </div>
      </div>

      <!-- Line Items -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <b>Line Items</b>
          <a href="{{ url_for('invoice_items.items_add') }}" class="btn btn-sm btn-outline-primary">+ Add Item</a>
        </div>

        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm" id="itemsTable">
            <thead>
              <tr>
                <th>Lot #</th>
                <th>Item</th>
                <th>Qty</th>
                <th>Units</th>
                <th>Unit Price</th>
                <th>Line Total</th>
                <th></th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td><input type="text" name="lot_number[]" class="form-control"></td>

                <td>
                  <select name="item[]" class="form-select item-select" data-tags="true">
                    <option value="">Select Item</option>
                    {% for it in items %}
                    <option value="{{ it.name }}" data-units="{{ it.default_units }}" data-price="{{ it.default_price }}">
                      {{ it.name }}
                    </option>
                    {% endfor %}
                  </select>
                </td>

                <td><input type="number" name="qty[]" class="form-control qty" step="0.01"></td>

                <td>
                  <select name="units[]" class="form-select units-select">
                    <option value="">Select Units</option>
                    <option value="Grams" selected>Grams</option>
                    <option value="kg">kg</option>
                    <option value="Units">Units</option>
                  </select>
                </td>

                <td><input type="number" name="unit_price[]" class="form-control price" step="0.01"></td>
                <td><input type="text" class="form-control line-total" readonly></td>
                <td><button type="button" class="btn btn-sm btn-danger removeItem">×</button></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Totals -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Subtotal</label>
          <input type="text" id="subtotal" name="subtotal" class="form-control" readonly>
        </div>

        <div class="col-md-3">
          <label class="form-label">Tax Rate (%)</label>
          <input type="number" name="tax_rate" id="tax_rate" class="form-control" value="13" step="0.01">
        </div>

        <div class="col-md-3">
          <label class="form-label">Shipping Cost</label>
          <input type="number" name="ship_cost" id="ship_cost" class="form-control" value="0" step="0.01">
        </div>

        <div class="col-md-3">
          <label class="form-label">Grand Total</label>
          <input type="text" id="grand_total" name="total" class="form-control" readonly>
        </div>
      </div>

      <input type="hidden" name="tax" id="tax_hidden">

      <div class="text-center">
        <button type="button" class="btn btn-secondary me-2" id="previewBtn">Preview</button>
        <button type="submit" class="btn btn-success me-2">Create Invoice & PDF</button>
      </div>

    </form>

  </div>
</div>

<!-- Delivery Date Polished -->
<script>
const deliveryInput = document.getElementById('delivery_date');

if (deliveryInput) {
    deliveryInput.addEventListener('focus', function () {
        if (this.value === 'TBD') {
            this.value = '';
        }
        this.type = 'date';
    });

    deliveryInput.addEventListener('blur', function () {
        if (this.value === '') {
            this.type = 'text';
            this.value = 'TBD';
        }
    });
}
</script>

<!-- Expose items to JS -->
<script>
window.invoiceItems = [
  {% for it in items %}
    {
      name: "{{ it.name }}",
      default_units: "{{ it.default_units or '' }}",
      default_price: "{{ it.default_price or '' }}"
    },
  {% endfor %}
];
</script>

<!-- Template Preview Switcher -->
<script>
const tplSelect = document.getElementById('templateSelect');
const tplClassicBtn = document.getElementById('tplClassicBtn');
const tplModernBtn = document.getElementById('tplModernBtn');

function setTemplate(value) {
    if (!tplSelect) return;
    tplSelect.value = value;
    if (tplClassicBtn && tplModernBtn) {
        tplClassicBtn.classList.toggle('btn-primary', value === 'classic');
        tplClassicBtn.classList.toggle('btn-outline-secondary', value !== 'classic');
        tplModernBtn.classList.toggle('btn-primary', value === 'modern');
        tplModernBtn.classList.toggle('btn-outline-secondary', value !== 'modern');
    }
}

if (tplClassicBtn) {
    tplClassicBtn.addEventListener('click', () => setTemplate('classic'));
}
if (tplModernBtn) {
    tplModernBtn.addEventListener('click', () => setTemplate('modern'));
}

// Initialize button state based on current select
if (tplSelect) {
    setTemplate(tplSelect.value || 'classic');
}
</script>

<!-- Preview Button -->
<script>
document.getElementById("previewBtn").addEventListener("click", function () {
    const form = document.querySelector("form");
    form.action = "{{ url_for('invoice.invoice_preview') }}";
    form.target = "_blank";
    form.submit();
    form.action = "{{ url_for('invoice.invoice_create') }}";
    form.target = "";
});
</script>

<script src="{{ url_for('static', filename='js/invoice.js') }}"></script>

{% endblock %}
