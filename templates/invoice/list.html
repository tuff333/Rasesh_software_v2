{% extends 'base.html' %}
{% block content %}

<div class="card shadow">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-journal-text"></i> Invoice Registry</h5>
    <a href="{{ url_for('invoice.invoice_create') }}" class="btn btn-success">
      <i class="bi bi-plus-circle"></i> New Invoice
    </a>
  </div>

  <div class="card-body">

    <!-- FILTERS (Module 8) -->
    <form method="GET" class="row g-3 mb-4">

      <div class="col-md-3">
        <label class="form-label">Search Invoice #</label>
        <input type="text" name="search" class="form-control"
               value="{{ search or '' }}" placeholder="MWR - 106">
      </div>

      <div class="col-md-3">
        <label class="form-label">Vendor</label>
        <select name="vendor" class="form-select">
          <option value="">All Vendors</option>
          {% for id, name in vendors.items() %}
            <option value="{{ id }}" {% if vendor_filter == id|string %}selected{% endif %}>
              {{ name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Type</label>
        <select name="type" class="form-select">
          <option value="">All</option>
          <option value="Invoice" {% if invoice_type == 'Invoice' %}selected{% endif %}>Invoice</option>
          <option value="Estimate" {% if invoice_type == 'Estimate' %}selected{% endif %}>Estimate</option>
          <option value="Quote" {% if invoice_type == 'Quote' %}selected{% endif %}>Quote</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">From</label>
        <input type="date" name="from" class="form-control" value="{{ date_from or '' }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">To</label>
        <input type="date" name="to" class="form-control" value="{{ date_to or '' }}">
      </div>

      <div class="col-12 text-end">
        <button class="btn btn-primary me-2">Apply Filters</button>
        <a href="{{ url_for('invoice_routes.invoice_list') }}" class="btn btn-secondary">Clear</a>
      </div>

    </form>

    <!-- INVOICE TABLE -->
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Invoice #</th>
          <th>Date</th>
          <th>Vendor</th>
          <th>Type</th>
          <th>Total</th>
          <th>PDF</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for inv in invoices %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ inv.num }}</td>
          <td>{{ inv.date }}</td>
          <td>{{ inv.vendor }}</td>
          <td>{{ inv.invoice_type }}</td>
          <td>${{ "%.2f"|format(inv.total) }}</td>

          <td>
            {% if inv.pdf %}
              <a href="{{ url_for('invoice_routes.invoice_download', filename=inv.pdf) }}"
                 class="btn btn-sm btn-outline-primary">
                <i class="bi bi-file-earmark-pdf"></i>
              </a>
            {% else %}
              <span class="text-muted">None</span>
            {% endif %}
          </td>

          <td class="text-end">

            <!-- View -->
            <a href="{{ url_for('invoice_routes.invoice_view', invoice_id=inv.id) }}"
               class="btn btn-sm btn-outline-secondary me-1">
              <i class="bi bi-eye"></i>
            </a>

            <!-- Edit (Module 7) -->
            <a href="{{ url_for('invoice_routes.invoice_edit', invoice_id=inv.id) }}"
               class="btn btn-sm btn-outline-primary me-1">
              <i class="bi bi-pencil"></i>
            </a>

            <!-- Duplicate (Module 9) -->
            <a href="{{ url_for('invoice_routes.invoice_duplicate', invoice_id=inv.id) }}"
               class="btn btn-sm btn-outline-warning me-1">
              <i class="bi bi-files"></i>
            </a>

            <!-- Delete -->
            <form method="POST"
                  action="{{ url_for('invoice_routes.invoice_delete', invoice_id=inv.id) }}"
                  style="display:inline-block;"
                  onsubmit="return confirm('Delete this invoice?');">
              <button class="btn btn-sm btn-outline-danger">
                <i class="bi bi-trash"></i>
              </button>
            </form>

          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>
</div>

{% endblock %}
